#!/usr/bin/env bash
# shellcheck shell=bash

log() {
  printf "\n\033[1;34m==> %s\033[0m\n" "$1"
}

log_success() {
  printf "\033[1;32mâœ” %s\033[0m\n" "$1"
}

log_warning() {
  printf "\033[1;33mâš  %s\033[0m\n" "$1"
}

log_error() {
  printf "\033[1;31mâœ– %s\033[0m\n" "$1"
}

run_cmd() {
  local title="$1"
  shift
  log "Executing: $*"
  if "$@"; then
    log_success "$title succeeded"
  else
    log_error "$title failed"
    exit 1
  fi
}

append_to_zshrc() {
  local text="$1" zshrc
  local skip_new_line="${2:-0}"

  if [ -w "$HOME/.zshrc.local" ]; then
    zshrc="$HOME/.zshrc.local"
  else
    zshrc="$HOME/.zshrc"
  fi

  if ! grep -Fqs "$text" "$zshrc"; then
    if [ "$skip_new_line" -eq 1 ]; then
      printf "%s\\n" "$text" >>"$zshrc"
    else
      printf "\\n%s\\n" "$text" >>"$zshrc"
    fi
  fi
}

update_shell() {
  local shell_path
  shell_path="$(command -v zsh)"

  log "Changing your shell to zsh ..."
  if ! grep "$shell_path" /etc/shells >/dev/null 2>&1; then
    run_cmd "adding '$shell_path' to /etc/shells" sudo sh -c "echo $shell_path >> /etc/shells"
    sudo chsh -s "$shell_path" "$USER"
  else
    log_success "already running zsh shell"
  fi
}

install_asdf_plugin() {
  local name="$1"
  local url="$2"

  if ! asdf plugin list 2>/dev/null | grep -Fq "$name"; then
    if [ -n "$url" ]; then
      run_cmd "installing asdf plugin '$name' from '$url'" asdf plugin add "$name" "$url"
    else
      run_cmd "installing asdf plugin '$name' from default source" asdf plugin add "$name"
    fi
  else
    run_cmd "updating asdf plugin '$name'" asdf plugin update "$name"
  fi
}

install_asdf_language() {
  if [ -z "$1" ]; then
    log_error "Error: Missing required language argument." >&2
    return 1
  fi

  local language="$1"
  local version="${2:-}"

  if [ -z "$version" ]; then
    version="$(asdf latest "$language")"
  fi

  if ! asdf list "$language" | grep -Fq "$version"; then
    run_cmd "installing $language $version" asdf install "$language" "$version"
    run_cmd "setting default $language version to $version" asdf set -u "$language" "$version"
  else
    log_success "$language $version already installed"
  fi
}

gem_install_or_update() {
  if gem list "$1" --installed >/dev/null; then
    run_cmd "updating $1 gem" gem update "$@"
  else
    run_cmd "installing $1 gem" gem install "$@"
  fi
}

install_cask_app() {
  local app_path="$1"
  local cask_name="$2"
  local display_name="${3:-$cask_name}"

  if [ ! -d "$app_path" ]; then
    run_cmd "installing $display_name" brew install --cask "$cask_name"
  else
    log_success "$display_name already installed"
  fi
}

trap 'ret=$?; test $ret -ne 0 && printf "failed\n\n" >&2; exit $ret' EXIT

set -e

log "Installing zshrc config ..."
if [ ! -f "$HOME/.zshrc" ]; then
  run_cmd "installing zshrc config" touch "$HOME/.zshrc"
else
  log_success "zshrc config already exists"
fi

log "Creating local scripts directory ..."
if [ ! -d "$HOME/.local/scripts/" ]; then
  run_cmd "creating local scripts directory" mkdir "$HOME/.local/scripts"
  append_to_zshrc 'export PATH="$HOME/.local/scripts:$PATH"'
else
  log_success "local scripts directory already exists"
fi

if [ "$(uname -m)" != "arm64" ]; then
  log_error "This script only supports Apple Silicon (M series) Macs."
  exit 1
fi

HOMEBREW_PREFIX="/opt/homebrew"

case "$SHELL" in
*/zsh)
  if [ "$(command -v zsh)" != "$HOMEBREW_PREFIX/bin/zsh" ]; then
    update_shell
  fi
  ;;
*)
  update_shell
  ;;
esac

log "Installing rosetta ..."
if ! pkgutil --pkg-info=com.apple.pkg.RosettaUpdateAuto >/dev/null 2>&1; then
  run_cmd "installing rosetta" softwareupdate --install-rosetta --agree-to-license
else
  log_success "rosetta already installed"
fi

log "Installing homebrew ..."
if ! command -v brew >/dev/null; then
  bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  append_to_zshrc "eval \"\$($HOMEBREW_PREFIX/bin/brew shellenv)\""
  export PATH="$HOMEBREW_PREFIX/bin:$PATH"

  log_success "installing homebrew succeeded"
else
  log_success "homebrew is already installed"
fi

log "Uninstalling old homebrew cask"
if brew list | grep -Fq brew-cask; then
  run_cmd "uninstalling old homebrew cask" brew uninstall --force brew-cask
else
  log_success "homebrew cask does not exist"
fi

brew analytics off

log "Installing homebrew packages ..."
brew bundle --file=- <<EOF
# Unix
brew "git"
brew "openssl"
brew "rcm"
brew "reattach-to-user-namespace"
brew "ripgrep"
brew "the_silver_searcher"
brew "tmux"
brew "wget"
brew "zsh"

# GitHub
brew "gh"

# Image manipulation
brew "imagemagick"

# Programming language prerequisites and package managers
brew "coreutils"
brew "libyaml" # should come after openssl
brew "readline"
brew "yarn"
brew "zlib"
brew "jq"

# Databases
brew "mysql-client", link: true
brew "libpq", link: true
EOF
log_success "homebrew packages installed"

log "Installing wkhtmltopdf ..."
if ! command -v wkhtmltopdf &>/dev/null; then
  run_cmd "downloading wkhtmltopdf" curl -L -o wkhtmltopdf.pkg \
    https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-2/wkhtmltox-0.12.6-2.macos-cocoa.pkg
  run_cmd "installing wkhtmltopdf" sudo installer -pkg wkhtmltopdf.pkg -target /
  rm wkhtmltopdf.pkg

  if ! command -v wkhtmltopdf &>/dev/null; then
    log_error "wkhtmltopdf installation failed"
    exit 1
  fi
else
  log_success "wkhtmltopdf already installed"
fi

log "Installing mac apps ..."
install_cask_app "/Applications/1Password.app" "1password" "1Password"
install_cask_app "/Applications/Docker.app" "docker" "Docker"
install_cask_app "/Applications/Google Chrome.app" "google-chrome" "Google Chrome"
install_cask_app "/Applications/Loom.app" "loom" "Loom"
install_cask_app "/Applications/Microsoft Teams.app" "microsoft-teams" "Microsoft Teams"
install_cask_app "/Applications/Slack.app" "slack" "Slack"
install_cask_app "/Applications/zoom.us.app" "zoom" "Zoom"

asdf_zsh_setup=$(
  cat <<'EOF'
# add shims directory to PATH
export PATH="${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
# append completions to fpath
fpath=(${ASDF_DATA_DIR:-$HOME/.asdf}/completions $fpath)
# initialise completions with ZSH's compinit
autoload -Uz compinit && compinit
EOF
)

log "Installing asdf ..."
if [ ! -d "$HOME/.asdf" ]; then
  run_cmd "installing asdf" brew install asdf
  append_to_zshrc "$asdf_zsh_setup"
else
  log_success "asdf already installed"
fi

log "Creating asdf config ..."
if [ ! -f "$HOME/.asdfrc" ]; then
  echo "legacy_version_file = yes" >"$HOME/.asdfrc"
  log_success "asdf config created"
else
  log_success "asdf config already exists"
fi

log "Installing Ruby ..."
append_to_zshrc '# Fix for installing older versions of Ruby'
append_to_zshrc 'export DLDFLAGS="-Wl,-undefined,dynamic_lookup"' 1
append_to_zshrc 'export OPENSSL_CFLAGS="-Wno-error=implicit-function-declaration"' 1
append_to_zshrc 'export CFLAGS=-Wno-error="implicit-function-declaration"' 1

# Export to current shell
export DLDFLAGS="-Wl,-undefined,dynamic_lookup"
export OPENSSL_CFLAGS="-Wno-error=implicit-function-declaration"
export CFLAGS=-Wno-error="implicit-function-declaration"

install_asdf_plugin "ruby" "https://github.com/asdf-vm/asdf-ruby.git"
install_asdf_language "ruby" "2.6.7"

log "Optimizing bundler ..."
if [ ! -f "$HOME/bundle/config" ]; then
  mkdir -p "$HOME/bundle"
  number_of_cores=$(sysctl -n hw.ncpu)
  printf "%s\n" "---\nBUNDLE_JOBS: \"$((number_of_cores - 1))\"" >"$HOME/bundle/config"
  log_success "optimizing bundler succeeded"
else
  log_success "bundler already optimized"
fi

log "Installing Node ..."
install_asdf_plugin "nodejs" "https://github.com/asdf-vm/asdf-nodejs.git"
install_asdf_language "nodejs"

log "Installing ssh key ..."
SSH_DIR="$HOME/.ssh"
KEY_FILE="$SSH_DIR/id_ed25519.pub"
PRIVATE_KEY="$SSH_DIR/id_ed25519"

if [ ! -f "$KEY_FILE" ]; then
  log_warning "No SSH key found. Let's create one."

  # Prompt for email until user enters something non-empty
  while [ -z "${EMAIL:-}" ]; do
    printf "Enter your @1000bulbs.com email to generate your SSH key: "
    read -r EMAIL
  done

  mkdir -p "$SSH_DIR"
  chmod 700 "$SSH_DIR"

  # Generate the key quietly
  run_cmd "generating SSH key" ssh-keygen -q -t ed25519 -C "$EMAIL" -f "$PRIVATE_KEY" -N ""

  # Secure private keys
  find "$SSH_DIR" -type f \( -name "id_*" ! -name "*.pub" \) -exec chmod 600 {} \;

  # Optionally make public keys readable by others
  find "$SSH_DIR" -type f -name "*.pub" -exec chmod 644 {} \;

  # Fix ownership (macOS safe)
  if command -v chown >/dev/null; then
    chown -R "$USER" "$SSH_DIR"
  fi

  log_success "âœ… SSH key created successfully!"
  echo "ðŸ“ Public key path: $KEY_FILE"
  echo
  echo "ðŸ”‘ Here is your public key:"
  echo "------------------------------------------------------------"
  cat "$KEY_FILE"
  echo "------------------------------------------------------------"

  # Upload key to GitHub if gh CLI is installed and not in CI
  if [ -z "$CI" ] && command -v gh >/dev/null; then
    echo
    echo "ðŸ‘‰ Now that you've seen your key, we can upload it to GitHub for you."
    printf "Do you want to upload this SSH key to GitHub now? [y/N] "
    read -r ANSWER
    case "$ANSWER" in
    [Yy]) # Matches Y or y
      # Check if already authenticated and has required scope
      if ! gh auth status --hostname github.com --show-token 2>/dev/null | grep -q 'admin:public_key'; then
        echo "ðŸ” Authenticating with GitHub (requesting admin:public_key scope)..."
        gh auth login --scopes "admin:public_key" --hostname github.com
      fi

      # Add SSH key
      run_cmd "uploading SSH key to GitHub" gh ssh-key add "$KEY_FILE" --title "$(hostname) - $(date +%Y-%m-%d)"
      ;;
    esac
  fi
else
  log_success "ssh key already installed"
fi

log "Adding ssh key to keychain ..."
if command -v ssh-add >/dev/null; then
  if ssh-add --apple-use-keychain "$PRIVATE_KEY" 2>/dev/null; then
    log_success "ssh key added to keychain"
  else
    log_warning "could not add ssh key to keychain (non-fatal)"
  fi
fi

# macOS Defaults Configuration
# This script customizes system behavior for a smoother and faster user experience.

# ========== UI/UX TWEAKS ==========

# Hide the menu bar automatically
# Revert: add the following line to ~/.laptop.local
#   defaults write NSGlobalDomain _HIHideMenuBar -bool false
defaults write NSGlobalDomain _HIHideMenuBar -bool true

# Enable Dock auto-hide
# Revert: add the following line to ~/.laptop.local
#   defaults write com.apple.dock autohide -bool false
defaults write com.apple.dock autohide -bool true

# Disable Dock hide/show delay for snappier feel
# Revert: add the following line to ~/.laptop.local
#   delete these keys or reset Dock defaults
defaults write com.apple.dock autohide-delay -float 0
defaults write com.apple.dock autohide-time-modifier -int 0

# Hide recent apps in Dock
# Revert: add the following line to ~/.laptop.local
#   defaults write com.apple.dock show-recents -bool true
defaults write com.apple.dock show-recents -bool false

# Prevent Spaces (Desktops) from rearranging based on recent use
# Revert: add the following line to ~/.laptop.local
#   defaults write com.apple.dock mru-spaces -bool true
defaults write com.apple.dock mru-spaces -bool false

# Always show scroll bars
# Options: "WhenScrolling", "Automatic" or "Always"
# Revert: add the following line to ~/.laptop.local
#   defaults write -g AppleShowScrollBars -string "Automatic"
defaults write -g AppleShowScrollBars -string "Always"

# Set Finder sidebar icon size to large
# Options: 1=Small, 2=Medium, 3=Large
# Revert: add the following line to ~/.laptop.local
#   defaults write -g NSTableViewDefaultSizeMode -int 2
defaults write -g NSTableViewDefaultSizeMode -int 3

# Always expand Save and Open panels by default
# Revert: add the following line to ~/.laptop.local
#   defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool false
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true

# Donâ€™t show the "open dialog" when launching document-based apps
# Revert: add the following line to ~/.laptop.local
#   defaults write -g NSShowAppCentricOpenPanelInsteadOfUntitledFile -bool true
defaults write -g NSShowAppCentricOpenPanelInsteadOfUntitledFile -bool false

# Show full file extensions in Finder
# Revert: add the following line to ~/.laptop.local
#   defaults write NSGlobalDomain AppleShowAllExtensions -bool false
defaults write NSGlobalDomain AppleShowAllExtensions -bool true

# Show path bar in Finder
# Revert: add the following line to ~/.laptop.local
#   defaults write com.apple.finder ShowPathbar -bool false
defaults write com.apple.finder ShowPathbar -bool true

# Disable the warning when changing a file extension
# Revert: add the following line to ~/.laptop.local
#   defaults write com.apple.finder FXEnableExtensionChangeWarning -bool true
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

# Set new Finder windows to open in Downloads
# Revert: add the following line to ~/.laptop.local
#   reset these keys or change path
defaults write com.apple.finder NewWindowTarget -string "PfLo"
defaults write com.apple.finder NewWindowTargetPath -string "file://$HOME/Downloads"

# ========== KEYBOARD & TEXT INPUT ==========

# Set a faster key repeat rate (lower is faster)
# Revert: add the following line to ~/.laptop.local
#   defaults write -g KeyRepeat -int 6 (or higher)
defaults write -g KeyRepeat -int 2

# Set a shorter delay before key repeat starts
# Revert: add the following line to ~/.laptop.local
#   defaults write -g InitialKeyRepeat -int 25 (or higher)
defaults write -g InitialKeyRepeat -int 15

# Disable auto-correct
# Revert: add the following line to ~/.laptop.local
#   defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool true
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

# Disable automatic capitalization
# Revert: add the following line to ~/.laptop.local
#   defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool true
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false

# Disable period substitution (double space = period)
# Revert: add the following line to ~/.laptop.local
#   defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool true
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false

# Disable smart quotes
# Revert: add the following line to ~/.laptop.local
#   defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool true
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false

# ========== TEXTEDIT ==========

# Set TextEdit to use plain text by default
# Revert: add the following line to ~/.laptop.local
#   defaults write com.apple.TextEdit RichText -bool true
defaults write com.apple.TextEdit RichText -bool false

# ========== ACTIVITY MONITOR ==========

# Set Activity Monitor update interval to 2 seconds
# Revert: add the following line to ~/.laptop.local
#   defaults write com.apple.ActivityMonitor UpdatePeriod -int 5
defaults write com.apple.ActivityMonitor UpdatePeriod -int 2

# ========== OPTIONAL EXTRAS ==========

# Disable .DS_Store files on network volumes (optional)
# Revert: add the following line to ~/.laptop.local
#   defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool false
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true

# Set screenshot format to PNG (optional)
# Revert: add the following line to ~/.laptop.local
#   defaults write com.apple.screencapture type -string "jpg"
defaults write com.apple.screencapture type -string "png"

if [ -f "$HOME/.laptop.local" ]; then
  log "Running your customizations from ~/.laptop.local ..."
  . "$HOME/.laptop.local"
fi

# Restart relevant system services
for app in "Dock" "Finder" "SystemUIServer"; do
  killall "$app" >/dev/null 2>&1 || true
done

log_success "Your laptop setup is complete! (Some changes may require a reboot to take full effect.)"
